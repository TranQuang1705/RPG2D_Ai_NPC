===========================================
HÆ¯á»šNG DáºªN TÃCH Há»¢P CHATBOT Vá»šI QUEST SYSTEM
===========================================

===========================================
1. Tá»”NG QUAN Há»† THá»NG
===========================================

Há»‡ thá»‘ng chatbot Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ hiá»ƒu vÃ  xá»­ lÃ½ cÃ¡c yÃªu cáº§u liÃªn quan Ä‘áº¿n quest:

CHATBOT (ChatBox.py)
   â†“ phÃ¢n tÃ­ch ngÃ´n ngá»¯ tá»± nhiÃªn
INTENT DETECTION (3 intent má»›i vá» quest)
   â†“ chuyá»ƒn Ä‘á»•i thÃ nh action
UNITY (ChatbotClient.cs)
   â†“ gá»­i action Ä‘áº¿n NPC
NPC (NPC.cs + NPCQuestGiver.cs)
   â†“ thá»±c thi action
QUEST SYSTEM (QuestManager, QuestPanel, etc.)


===========================================
2. CÃC INTENT Má»šI ÄÆ¯á»¢C THÃŠM VÃ€O
===========================================

1. ask_for_quest
   ----------------
   Trigger khi: NgÆ°á»i chÆ¡i há»i NPC cÃ³ cáº§n giÃºp gÃ¬ khÃ´ng
   
   VÃ­ dá»¥ cÃ¢u:
   - "Do you need help?"
   - "Do you need anything?"
   - "Can I help you?"
   - "Any task for me?"
   - "Do you have work for me?"
   - "What can I do for you?"
   - "Any quests?"
   - "Got any jobs?"
   
   Action: ASK_FOR_QUEST
   Káº¿t quáº£: NPC sáº½ giao quest (cÃ³ sáºµn hoáº·c random)


2. quest_status
   ----------------
   Trigger khi: NgÆ°á»i chÆ¡i há»i vá» quest hiá»‡n táº¡i
   
   VÃ­ dá»¥ cÃ¢u:
   - "What is my quest?"
   - "Show my quests"
   - "What tasks do I have?"
   - "Check my quest progress"
   - "Quest status"
   - "How is my quest going?"
   - "What am I supposed to do?"
   
   Action: SHOW_QUEST_STATUS
   Káº¿t quáº£: Má»Ÿ QuestPanel UI hiá»ƒn thá»‹ táº¥t cáº£ quest


3. complete_quest
   ----------------
   Trigger khi: NgÆ°á»i chÆ¡i muá»‘n ná»™p/hoÃ n thÃ nh quest
   
   VÃ­ dá»¥ cÃ¢u:
   - "I finished the quest"
   - "Quest done"
   - "I completed the task"
   - "Here are the items"
   - "I have what you need"
   - "Task completed"
   - "I'm done with the quest"
   - "Turn in quest"
   
   Action: COMPLETE_QUEST
   Káº¿t quáº£: Ná»™p quest vÃ  nháº­n pháº§n thÆ°á»Ÿng


===========================================
3. CÃCH HOáº T Äá»˜NG Cá»¦A Há»† THá»NG
===========================================

BÆ¯á»šC 1: Player nÃ³i vá»›i NPC
   - Player: "Do you need anything?"

BÆ¯á»šC 2: Unity gá»­i message Ä‘áº¿n ChatBox.py
   POST http://127.0.0.1:5000/chat
   Body: {"text": "Do you need anything?", "session_id": "default"}

BÆ¯á»šC 3: ChatBox.py phÃ¢n tÃ­ch intent
   - Sá»­ dá»¥ng Sentence Transformer (all-MiniLM-L6-v2)
   - TÃ­nh cosine similarity vá»›i cÃ¡c vÃ­ dá»¥ intent
   - Náº¿u confidence tháº¥p â†’ dÃ¹ng LM Studio (Llama) Ä‘á»ƒ classify
   - Káº¿t quáº£: intent = "ask_for_quest"

BÆ¯á»šC 4: ChatBox.py sinh response tá»« AI
   - Gá»i LM Studio API vá»›i system prompt cá»§a NPC
   - NPC Snow: "Oh, yes! I need help collecting wildflowers..."
   - Äá»“ng thá»i sinh audio TTS (Edge TTS)

BÆ¯á»šC 5: ChatBox.py map intent â†’ action
   intent = "ask_for_quest"
   â†’ action = "ASK_FOR_QUEST"
   â†’ params = {"trigger": "player_ask_help"}

BÆ¯á»šC 6: ChatBox.py tráº£ response vá» Unity
   Response: {
     "reply": "Oh, yes! I need help...",
     "audio_url": "http://127.0.0.1:5000/audio/tmp_abc123.mp3",
     "intent": "ask_for_quest",
     "action": "ASK_FOR_QUEST",
     "params": {"trigger": "player_ask_help"}
   }

BÆ¯á»šC 7: ChatbotClient.cs nháº­n vÃ  xá»­ lÃ½
   - Láº¥y reply text â†’ gá»­i Ä‘áº¿n NPC.SpeakResponse()
   - Láº¥y action â†’ gá»i NPC.HandleChatbotAction()

BÆ¯á»šC 8: NPC xá»­ lÃ½ action
   - NPC.HandleChatbotAction("ASK_FOR_QUEST", params)
   - Gá»i NPCQuestGiver.OnPlayerAskForQuest()

BÆ¯á»šC 9: NPCQuestGiver xá»­ lÃ½
   - Kiá»ƒm tra NPC cÃ³ quest sáºµn khÃ´ng
   - Náº¿u khÃ´ng â†’ random quest tá»« pool
   - Gá»i QuestManager.AcceptQuest(questId)

BÆ¯á»šC 10: QuestManager cáº­p nháº­t database
   - POST http://127.0.0.1:5002/player_quests/accept
   - Database cáº­p nháº­t player_quests vÃ  player_quest_progress

BÆ¯á»šC 11: UI cáº­p nháº­t
   - QuestPanel xuáº¥t hiá»‡n (náº¿u Ä‘ang áº©n)
   - Hiá»ƒn thá»‹ sá»‘ lÆ°á»£ng quest active
   - Player cÃ³ thá»ƒ click Ä‘á»ƒ xem chi tiáº¿t


===========================================
4. SETUP TRONG UNITY
===========================================

A. Táº O CHATBOT CLIENT
   ----------------------
   1. Táº¡o Empty GameObject: "ChatbotClient"
   2. Add Component: ChatbotClient.cs
   3. Inspector settings:
      â”œâ”€ Chatbot Url: http://127.0.0.1:5000/chat
      â””â”€ Session Id: default (hoáº·c unique per player)


B. KIá»‚M TRA NPC SETUP
   ----------------------
   Má»—i NPC cáº§n cÃ³:
   1. NPC.cs (Ä‘Ã£ cÃ³ sáºµn)
   2. NPCQuestGiver.cs (thÃªm vÃ o)
   3. (Optional) NpcChatSpeaker.cs (náº¿u dÃ¹ng TTS)


C. KIá»‚M TRA QUEST SYSTEM
   ----------------------
   Scene pháº£i cÃ³:
   1. QuestManager GameObject
   2. QuestProgressTracker GameObject
   3. QuestPanel UI trong Canvas


===========================================
5. TESTING FLOW
===========================================

TEST 1: Player há»i quest
   ----------------------
   1. Cháº¡y Flask servers:
      - Terminal 1: cd Assets/Web_Item/python_sever/ && python database.py
      - Terminal 2: python ChatBox.py
   
   2. Cháº¡y Unity game
   
   3. Tiáº¿n Ä‘áº¿n NPC Snow
   
   4. NÃ³i: "Do you need anything?"
   
   5. Kiá»ƒm tra Console logs:
      âœ… "ğŸ’¬ ChatbotClient: Sending message: Do you need anything?"
      âœ… "âœ… ChatbotClient: Response received"
      âœ… "ğŸ¯ Intent: ask_for_quest"
      âœ… "ğŸ® Action: ASK_FOR_QUEST"
      âœ… "ğŸ’¬ NPC: Player asked if I need anything"
      âœ… "ğŸ“œ NPC gives quest: Gather 10 Wildflowers"
      âœ… "âœ… Quest accepted!"
   
   6. Kiá»ƒm tra UI:
      âœ… QuestPanel xuáº¥t hiá»‡n vá»›i sá»‘ "1"
      âœ… NPC cÃ³ dáº¥u cháº¥m than vÃ ng (!)


TEST 2: Player xem quest status
   ----------------------
   1. Trong khi cÃ³ quest active
   
   2. NÃ³i vá»›i báº¥t ká»³ NPC nÃ o: "What is my quest?"
   
   3. Kiá»ƒm tra:
      âœ… Intent: quest_status
      âœ… Action: SHOW_QUEST_STATUS
      âœ… QuestDetailPanel má»Ÿ ra
      âœ… Hiá»ƒn thá»‹ danh sÃ¡ch quest vÃ  chi tiáº¿t


TEST 3: Player hoÃ n thÃ nh quest
   ----------------------
   1. Nháº·t Ä‘á»§ 10 wildflowers (hoáº·c hoÃ n thÃ nh objective)
   
   2. Quay láº¡i NPC Snow
   
   3. NÃ³i: "I finished the quest"
   
   4. Kiá»ƒm tra:
      âœ… Intent: complete_quest
      âœ… Action: COMPLETE_QUEST
      âœ… NPC cÃ³ dáº¥u cháº¥m than xanh (!) chuyá»ƒn thÃ nh khÃ´ng cÃ³
      âœ… Nháº­n pháº§n thÆ°á»Ÿng (gold, exp)
      âœ… Console: "âœ… Quest completed!"
      âœ… QuestPanel áº©n Ä‘i (náº¿u khÃ´ng cÃ²n quest)


===========================================
6. LUá»’NG Xá»¬ LÃ KEYWORD FALLBACK
===========================================

NgoÃ i AI intent detection, há»‡ thá»‘ng cÃ²n cÃ³ keyword fallback:

NPC.cs â†’ HandleChatbotIntegration():
   - Kiá»ƒm tra tá»« khÃ³a Ä‘Æ¡n giáº£n trong text
   - "need" + "anything/help" â†’ OnPlayerAskForQuest()
   - "quest" / "task" â†’ OnPlayerInteract()
   - "finished/completed/done" â†’ OnPlayerInteract()

Äiá»u nÃ y Ä‘áº£m báº£o há»‡ thá»‘ng váº«n hoáº¡t Ä‘á»™ng ngay cáº£ khi:
   - ChatBot server khÃ´ng cháº¡y
   - Intent detection sai
   - Player dÃ¹ng cÃ¢u ngáº¯n gá»n


===========================================
7. Cáº¤U HÃŒNH NPC SYSTEM PROMPT
===========================================

Äá»ƒ NPC pháº£n há»“i Ä‘Ãºng vá» quest, cáº­p nháº­t system_prompt trong ChatBox.py:

VÃ Dá»¤ CHO NPC SNOW:
```python
system_prompt = (
    "You are Snow, a gentle young girl in the countryside. "
    "You love picking wildflowers and need help gathering them. "
    "When player asks if you need help, you happily tell them about "
    "collecting 10 wildflowers in the meadow. "
    "You are kind, soft-spoken, and warm-hearted. "
    "Always reply as Snow, briefly and naturally.\n"
    "Never include code blocks, JSON, or technical details."
)
```

TÃ¹y chá»‰nh system_prompt cho tá»«ng NPC Ä‘á»ƒ phÃ¹ há»£p tÃ­nh cÃ¡ch!


===========================================
8. TROUBLESHOOTING
===========================================

Lá»–I: Intent khÃ´ng Ä‘Æ°á»£c detect Ä‘Ãºng
âœ… GIáº¢I PHÃP:
   - ThÃªm vÃ­ dá»¥ cÃ¢u vÃ o INTENT_EXAMPLES trong ChatBox.py
   - Giáº£m INTENT_THRESHOLD (hiá»‡n táº¡i 0.55)
   - Kiá»ƒm tra LM Studio Ä‘ang cháº¡y


Lá»–I: Action khÃ´ng Ä‘Æ°á»£c thá»±c thi
âœ… GIáº¢I PHÃP:
   - Kiá»ƒm tra ChatbotClient GameObject cÃ³ trong scene
   - Kiá»ƒm tra NPC cÃ³ NPCQuestGiver component
   - Xem Console logs Ä‘á»ƒ trace flow


Lá»–I: ChatBox.py khÃ´ng response
âœ… GIáº¢I PHÃP:
   - Kiá»ƒm tra server cháº¡y: python ChatBox.py
   - Kiá»ƒm tra port 5000 khÃ´ng bá»‹ chiáº¿m
   - Test API báº±ng Postman:
     POST http://127.0.0.1:5000/chat
     Body: {"text": "hello", "session_id": "test"}


Lá»–I: Quest khÃ´ng Ä‘Æ°á»£c accept
âœ… GIáº¢I PHÃP:
   - Kiá»ƒm tra database.py server (port 5002)
   - Kiá»ƒm tra database cÃ³ quest data
   - Kiá»ƒm tra NPC ID khá»›p vá»›i npc_quests table


Lá»–I: TTS audio khÃ´ng phÃ¡t
âœ… GIáº¢I PHÃP:
   - Kiá»ƒm tra edge-tts Ä‘Ã£ cÃ i: pip install edge-tts
   - Kiá»ƒm tra folder tmp/ Ä‘Æ°á»£c táº¡o
   - Kiá»ƒm tra audio_url cÃ³ trong response


===========================================
9. Má» Rá»˜NG Há»† THá»NG
===========================================

THÃŠM INTENT Má»šI:
   1. ThÃªm vÃ o INTENT_EXAMPLES trong ChatBox.py
   2. ThÃªm keyword check trong NPC.cs
   3. ThÃªm action mapping trong ChatBox.py
   4. ThÃªm handler trong ChatbotClient.cs
   5. ThÃªm xá»­ lÃ½ trong NPC.cs


THÃŠM QUEST TYPE Má»šI:
   1. ThÃªm objective_type trong database
   2. Cáº­p nháº­t QuestProgressTracker.cs
   3. ThÃªm intent example náº¿u cáº§n


THÃŠM NPC Má»šI Vá»šI QUEST:
   1. Táº¡o NPC GameObject
   2. Add NPC.cs vÃ  NPCQuestGiver.cs
   3. Set NPC ID trong Inspector
   4. Insert data vÃ o database (npcs, npc_quests)
   5. TÃ¹y chá»‰nh system_prompt trong ChatBox.py


===========================================
10. CÃC FILE LIÃŠN QUAN
===========================================

PYTHON (Backend):
   â”œâ”€ Assets/ChatBox.py (Chatbot + Intent Detection)
   â””â”€ Assets/Web_Item/python_sever/database.py (Quest API)

UNITY (Frontend):
   â”œâ”€ Assets/Scripts/ChatbotClient.cs (NEW - Chatbot API client)
   â”œâ”€ Assets/Scripts/NPC.cs (UPDATED - ThÃªm HandleChatbotAction)
   â”œâ”€ Assets/Scripts/NPCQuestGiver.cs (Quest interaction)
   â”œâ”€ Assets/Scripts/Database/QuestManager.cs (Quest management)
   â”œâ”€ Assets/Scripts/Ui/QuestPanel.cs (Quest UI)
   â””â”€ Assets/Scripts/QuestProgressTracker.cs (Progress tracking)


===========================================
Káº¾T LUáº¬N
===========================================

Há»‡ thá»‘ng chatbot Ä‘Ã£ Ä‘Æ°á»£c tÃ­ch há»£p hoÃ n toÃ n vá»›i quest system:

âœ… NPC hiá»ƒu ngÃ´n ngá»¯ tá»± nhiÃªn vá» quest
âœ… Tá»± Ä‘á»™ng giao quest khi player há»i
âœ… Hiá»ƒn thá»‹ quest status theo yÃªu cáº§u
âœ… HoÃ n thÃ nh vÃ  nháº­n thÆ°á»Ÿng thÃ´ng qua dialogue
âœ… CÃ³ keyword fallback khi AI khÃ´ng cháº¯c cháº¯n

Player cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c tá»± nhiÃªn vá»›i NPC mÃ  khÃ´ng cáº§n nhá»› cÃ¢u lá»‡nh!
